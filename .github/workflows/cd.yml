name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      
permissions: {}

jobs:
  publish-latest-update-site:
    name: Publish Latest Update Site # (from main branch only)
    runs-on: ubuntu-latest
    
    # we are very restrictive when this runs, i.e. only on main, only on success and only with the bazel-eclipse repository (not on forks)
    if: >
      github.event.workflow_run.conclusion == 'success' && 
      github.event.workflow_run.event != 'pull_request' &&
      github.repository == 'salesforce/bazel-eclipse' && 
      github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Download p2 Repository
        uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: p2-repository
          path: bazel-eclipse-latest
          skip_unpack: true

      - name: Extract p2 Repository
        run: unzip bazel-eclipse-latest/p2-repository.zip -d bazel-eclipse-latest

      - name: Display structure of the update site
        run: ls -R  bazel-eclipse-latest

      - name: Deploy Update Site ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: bazel-eclipse-latest
          target-folder: latest # use a simpler name
          clean: true
          clean-exclude: |
            index.html
            update-site*
          single-commit: true
          
